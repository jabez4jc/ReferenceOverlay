<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Overlay — Control</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="icon" type="image/png" href="assets/brand/favicon-32.png" sizes="32x32" />
  <link rel="apple-touch-icon" href="assets/brand/apple-touch-icon.png" />
  <!-- Google Fonts: Display, Elegant Serif, and Modern Sans options -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@300;400;500;600;700;800;900&family=Anton&family=Archivo:wght@400;500;600;700;800&family=Bebas+Neue&family=Cinzel:wght@400;700&family=Cinzel+Decorative:wght@400;700&family=Concert+One&family=Cormorant+Garamond:wght@400;700&family=Crimson+Pro:wght@400;700&family=EB+Garamond:wght@400;700&family=Geist:wght@300;400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700;800;900&family=Josefin+Sans:wght@400;700&family=Lexend:wght@300;400;500;600;700;800&family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;700&family=Merriweather:wght@400;700&family=Montserrat:wght@400;700&family=Noto+Sans+Devanagari:wght@400;700&family=Noto+Sans+Kannada:wght@400;700&family=Noto+Sans+Malayalam:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&family=Noto+Sans+Telugu:wght@400;700&family=Nunito:wght@300;400;500;600;700;800;900&family=Oswald:wght@400;700&family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600;700;800;900&family=Quicksand:wght@300;400;500;600;700&family=Raleway:wght@400;700&family=Rethink+Sans:wght@400;500;600;700;800&family=Rubik:wght@300;400;500;600;700;800;900&family=Unbounded:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/control.css" />
</head>
<body>

<div id="session-modal" class="session-modal" aria-hidden="true" role="dialog" aria-labelledby="session-modal-title">
  <div class="session-modal-backdrop"></div>
  <div class="session-modal-dialog" role="document">
    <h2 id="session-modal-title">Choose Session ID</h2>
    <p class="session-modal-help">Enter Session ID (letters, numbers, - or _)</p>
    <input id="session-modal-input" type="text" autocomplete="off" spellcheck="false" maxlength="40" />
    <div id="session-modal-error" class="session-modal-error" aria-live="polite"></div>
    <div class="session-modal-actions">
      <button type="button" class="btn-session" id="session-modal-cancel">Cancel</button>
      <button type="button" class="btn-settings-toggle" id="session-modal-ok">Continue</button>
    </div>
  </div>
</div>

<div class="app">

  <!-- ── Header ──────────────────────────────────────────────────────────── -->
  <header class="app-header">
    <div class="header-left">
      <img class="logo-icon" src="assets/brand/reference-overlay-mark.svg" alt="Overlay logo" />
      <h1>Overlay</h1>
    </div>
    <div class="header-right">
      <span id="status-pill" class="status-pill status-off">OFF AIR</span>
      <span id="ws-indicator" class="ws-indicator" data-state="offline" title="WebSocket server not running"></span>
      <button class="btn-session-id" id="btn-session-id" onclick="copyOutputLink()" title="Click to copy output window URL to clipboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        <span id="session-id-text">#…</span>
      </button>
      <button class="btn-session" id="btn-new-session" onclick="openNewSession()" title="Open a fresh independent session in a new tab">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New Session
      </button>
      <button class="btn-output-link" id="btn-open-output" onclick="openOutputWindow()" title="Open output window (click again for additional outputs)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        Output Window
      </button>
      <button class="btn-session" id="btn-user-guide" onclick="openUserGuide()" title="Open user guide">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        User Guide
      </button>
      <button class="btn-settings-toggle" id="btn-settings-toggle" onclick="toggleSettingsPanel()" title="Toggle settings panel" aria-expanded="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M4.93 4.93a10 10 0 0 0 0 14.14"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2"/></svg>
        <span class="btn-settings-label">Settings</span>
      </button>
    </div>
  </header>

  <!-- ── Mode Toggle ──────────────────────────────────────────────────────── -->
  <div class="mode-toggle">
    <button id="tab-bible" class="mode-tab active" onclick="setMode('bible')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
      Bible Reference
    </button>
    <button id="tab-speaker" class="mode-tab" onclick="setMode('speaker')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Speaker
    </button>
    <button id="tab-ticker" class="mode-tab" onclick="setMode('ticker')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><polyline points="15 6 21 12 15 18"/></svg>
      Ticker
    </button>
  </div>

  <!-- ── Main Content ─────────────────────────────────────────────────────── -->
  <main class="app-main">
    <div class="control-column">

    <!-- ── Bible Reference Panel ──────────────────────────────────────────── -->
    <section id="panel-bible" class="panel">
      <div class="field-grid bible-grid">

        <div class="field-group bible-book">
          <label for="book">Book</label>
          <select id="book" onchange="onBookChange()">
            <optgroup label="Old Testament" id="optgroup-ot"></optgroup>
            <optgroup label="New Testament" id="optgroup-nt"></optgroup>
          </select>
        </div>

        <div class="field-group bible-chapter">
          <label for="chapter">Chapter</label>
          <select id="chapter" onchange="onBibleChange()"></select>
        </div>

        <div class="field-group bible-verse">
          <label for="verse-ref">
            Verse(s)
            <span class="label-hint">e.g. 19 &nbsp;·&nbsp; 19-21 &nbsp;·&nbsp; 19, 22 &nbsp;·&nbsp; 19-21, 25</span>
          </label>
          <input type="text" id="verse-ref" placeholder="e.g. 19 or 19-21 or 19-21, 25"
                 onchange="onBibleChange()" oninput="onBibleChange()" />
          <div id="verse-validation" class="verse-validation"></div>
        </div>

        <div class="field-group bible-translation">
          <label for="translation">Translation</label>
          <select id="translation" onchange="onBibleChange()"></select>
        </div>
        <div class="field-group bible-ref-lang">
          <label for="reference-language">Reference Language</label>
          <select id="reference-language" onchange="onReferenceLanguageChange()"></select>
        </div>

        <div class="field-group span-full bible-line-options">
          <label class="verse-text-include">
            <input type="checkbox" id="hide-translation-line2" checked onchange="onBibleLineOptionsChange()" />
            Hide translation line (Line 2)
          </label>
          <label class="verse-text-include">
            <input type="checkbox" id="append-translation-abbr-line1" onchange="onBibleLineOptionsChange()" />
            Append translation abbreviation on line 1
          </label>
        </div>

        <!-- ── Verse Text Lookup ─────────────────────────────────────────── -->
        <div class="field-group span-full">
          <div class="lookup-bar">
            <button class="btn-lookup" onclick="lookupVerse()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Look Up Text
            </button>
            <span id="lookup-status" class="lookup-status"></span>
          </div>
          <div id="verse-text-box" class="verse-text-box" style="display:none">
            <p id="verse-text-content" class="verse-text-content"></p>
            <span id="verse-ref-note" class="verse-ref-note" style="display:none">Verification only — ASV (not sent to output)</span>
            <label class="verse-text-include">
              <input type="checkbox" id="include-verse-text" onchange="onBibleLineOptionsChange()" />
              Use verse text as line 2 in output
            </label>
          </div>
        </div>

      </div>
    </section>

    <!-- ── Speaker Panel ──────────────────────────────────────────────────── -->
    <section id="panel-speaker" class="panel hidden">
      <div class="field-grid speaker-grid">

        <div class="field-group speaker-name">
          <label for="speaker-name">Speaker Name</label>
          <input type="text" id="speaker-name"
                 placeholder="e.g. Suresh Abraham"
                 onchange="onSpeakerChange()" oninput="onSpeakerChange()" />
        </div>

        <div class="field-group speaker-title">
          <label for="speaker-title">
            Title / Role
            <span class="label-hint">optional</span>
          </label>
          <input type="text" id="speaker-title"
                 placeholder="e.g. Senior Pastor"
                 onchange="onSpeakerChange()" oninput="onSpeakerChange()" />
        </div>

      </div>
    </section>

    <!-- ── Ticker Panel ───────────────────────────────────────────────────── -->
    <section id="panel-ticker" class="panel hidden">
      <div class="ticker-panel-grid ticker-grid">

        <div class="field-group span-full">
          <label for="ticker-message">
            Ticker Message
            <span class="label-hint">scrolls right → left on the output</span>
          </label>
          <textarea id="ticker-message" rows="3"
            style="width:100%;padding:9px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:var(--font);font-size:.95rem;resize:vertical;"
            placeholder="e.g. ⚠ Emergency service cancelled — please check the foyer for updates"
            oninput="onTickerChange()">The Live Stream has been restored. Thank you for your patience, and our sincere apologies for the interruption.</textarea>
        </div>

        <div class="field-group ticker-badge">
          <label for="ticker-label">Badge Label</label>
          <input type="text" id="ticker-label" value="INFO"
                 placeholder="INFO"
                 oninput="onTickerChange()" onchange="onTickerChange()" />
        </div>

        <div class="field-group ticker-speed">
          <label for="ticker-speed">Scroll Speed</label>
          <select id="ticker-speed" onchange="onTickerChange()">
            <option value="80">Slow</option>
            <option value="140" selected>Normal</option>
            <option value="220">Fast</option>
            <option value="320">Very Fast</option>
          </select>
        </div>

        <div class="field-group ticker-style">
          <label for="ticker-style">Style</label>
          <select id="ticker-style" onchange="onTickerStyleChange()">
            <option value="alert">Alert (red)</option>
            <option value="info">Info (blue)</option>
            <option value="warning">Warning (amber)</option>
            <option value="dark" selected>Dark</option>
            <option value="custom">Custom colors…</option>
          </select>
        </div>

        <div class="field-group ticker-position">
          <label for="ticker-position">Position</label>
          <select id="ticker-position" onchange="onTickerChange()">
            <option value="bottom" selected>Bottom</option>
            <option value="top">Top</option>
          </select>
        </div>

        <!-- Custom colors — hidden unless style=custom -->
        <div id="ticker-custom-colors">
          <div class="field-group">
            <label class="setting-label" for="ticker-bg-color">Background</label>
            <input type="color" id="ticker-bg-color" value="#cc0000" onchange="onTickerChange()" />
          </div>
          <div class="field-group">
            <label class="setting-label" for="ticker-text-color">Text</label>
            <input type="color" id="ticker-text-color" value="#ffffff" onchange="onTickerChange()" />
          </div>
        </div>

        <div class="field-group ticker-size">
          <label for="ticker-bar-height">
            Ticker Height
            <span class="label-hint" id="ticker-bar-height-val">68px</span>
          </label>
          <input type="range" id="ticker-bar-height" min="36" max="120" step="2" value="68" oninput="onTickerSizeInput()" onchange="onTickerChange()" />
        </div>

        <div class="field-group ticker-text-size">
          <label for="ticker-font-size">
            Text Size
            <span class="label-hint" id="ticker-font-size-val">28px</span>
          </label>
          <input type="range" id="ticker-font-size" min="16" max="56" step="1" value="28" oninput="onTickerSizeInput()" onchange="onTickerChange()" />
        </div>

        <div class="field-group ticker-badge-size">
          <label for="ticker-badge-size">
            Badge Size
            <span class="label-hint" id="ticker-badge-size-val">22px</span>
          </label>
          <input type="range" id="ticker-badge-size" min="14" max="44" step="1" value="22" oninput="onTickerSizeInput()" onchange="onTickerChange()" />
        </div>

        <div class="field-group ticker-force-text">
          <label class="template-toggle-label">
            <input type="checkbox" id="ticker-force-text-color" onchange="onTickerChange()" />
            Force Text Color
          </label>
          <input type="color" id="ticker-text-color-override" value="#ffffff" onchange="onTickerChange()" />
        </div>

      </div>
    </section>

    <!-- ── Program + Preview Monitors ─────────────────────────────────────── -->
    <section class="monitors-section">

      <!-- ── PGM (Program) — frozen snapshot of what is currently live ─── -->
      <div class="monitor-block" id="monitor-program-block">
        <div class="monitor-label monitor-label-pgm" id="monitor-pgm-label">
          <span class="monitor-dot"></span> PGM
        </div>
        <div class="monitor-viewport">
          <div class="preview-bg"></div>
          <!-- Lower-third content when overlay is live -->
          <div class="lower-third-wrap" id="program-wrap" style="display:none">
            <div class="lower-third" id="program-lower-third">
              <div class="lt-accent" id="program-accent"></div>
              <img class="lt-logo hidden" id="program-logo" alt="Logo" />
              <div class="lt-text" id="program-lt-text">
                <div class="lt-line1" id="program-line1"></div>
                <div class="lt-line2" id="program-line2"></div>
              </div>
            </div>
          </div>
          <!-- Custom template PGM snapshot (mirrors output positioning/scaling) -->
          <div class="preview-custom-wrap" id="program-custom-wrap" style="display:none">
            <div class="monitor-custom-stage" id="program-custom-stage">
              <div id="program-custom"></div>
            </div>
          </div>
          <!-- Ticker content when ticker is live -->
          <div class="preview-ticker-wrap" id="program-ticker-wrap" style="display:none">
            <div class="preview-ticker-bar" id="program-ticker-bar">
              <div class="preview-ticker-badge" id="program-ticker-badge">INFO</div>
              <div class="preview-ticker-text" id="program-ticker-text"></div>
            </div>
          </div>
          <!-- Off-air overlay (shown when nothing is live) -->
          <div class="monitor-off-air" id="program-off-air">OFF AIR</div>
        </div>
      </div>

      <!-- ── PVW (Preview) — live-updating, what will go next ─────────── -->
      <div class="monitor-block">
        <div class="monitor-label monitor-label-pvw">PVW</div>
        <div class="monitor-viewport preview-viewport">
          <div class="preview-bg"></div>
          <!-- Standard lower-third preview (hidden when custom template is active) -->
          <div class="lower-third-wrap" id="preview-wrap">
            <div class="lower-third" id="preview-lower-third">
              <div class="lt-accent"></div>
              <img class="lt-logo hidden" id="preview-logo" alt="Logo" />
              <div class="lt-text">
                <div class="lt-line1" id="preview-line1">John 3:16-18</div>
                <div class="lt-line2" id="preview-line2">King James Version</div>
              </div>
            </div>
          </div>
          <!-- Custom template preview (shown when custom template is enabled) -->
          <div class="preview-custom-wrap" id="preview-custom-wrap" style="display:none">
            <div class="monitor-custom-stage" id="preview-custom-stage">
              <div id="preview-custom"></div>
            </div>
          </div>
          <!-- Ticker preview (shown when ticker mode is active) -->
          <div class="preview-ticker-wrap" id="preview-ticker-wrap" style="display:none">
            <div class="preview-ticker-bar" id="preview-ticker-bar">
              <div class="preview-ticker-badge" id="preview-ticker-badge">INFO</div>
              <div class="preview-ticker-text" id="preview-ticker-text"></div>
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- ── Presets ────────────────────────────────────────────────────────── -->
    <section class="presets-section">
      <div class="presets-header">
        <span class="presets-label" id="presets-label">Reference Presets</span>
        <div class="presets-actions">
          <button class="btn-save-preset" onclick="saveCurrentPreset()" title="Save current settings as a preset">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Save
          </button>
          <button class="btn-preset-io" onclick="exportPresets()" title="Export all presets as a JSON file — open on another device to import">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export
          </button>
          <button class="btn-preset-io" onclick="importPresets()" title="Import presets from a JSON file — merges with existing presets">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3" transform="rotate(180 12 9)"/></svg>
            Import
          </button>
        </div>
      </div>
      <!-- Overlay presets (Bible + Speaker) -->
      <div class="presets-list" id="presets-list-overlay">
        <span class="presets-empty" id="presets-empty-overlay">No presets saved — click Save Current to add one</span>
      </div>
      <!-- Ticker presets (hidden when not in ticker mode) -->
      <div class="presets-list" id="presets-list-ticker" style="display:none">
        <span class="presets-empty" id="presets-empty-ticker">No ticker presets saved — click Save Current to add one</span>
      </div>

      <div class="settings-profiles">
        <div class="settings-profiles-label">Settings Profiles</div>
        <div class="settings-profiles-row">
          <select id="settings-profile-select" class="settings-profiles-select">
            <option value="">No settings profiles yet</option>
          </select>
          <button class="btn-preset-io" onclick="saveSettingsProfile()" title="Save full session settings + all presets as a global profile">Save Profile</button>
          <button class="btn-preset-io" onclick="loadSelectedSettingsProfile()" title="Load selected profile into this session">Load</button>
          <button class="btn-preset-io" onclick="deleteSelectedSettingsProfile()" title="Delete selected settings profile">Delete</button>
          <button class="btn-preset-io" onclick="exportSettingsProfiles()" title="Export all settings profiles to JSON">Export</button>
          <button class="btn-preset-io" onclick="importSettingsProfiles()" title="Import settings profiles from JSON">Import</button>
        </div>
      </div>
    </section>

    <!-- ── Action Buttons ─────────────────────────────────────────────────── -->
    <section class="actions">
      <button class="btn-show" id="btn-show" onclick="sendShow()">
        <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        CUT TO AIR
      </button>
      <button class="btn-clear" id="btn-clear" onclick="sendClear()">
        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
        CLEAR
      </button>
    </section>

    <!-- ── Keyboard Shortcut Hint ─────────────────────────────────────────── -->
    <div class="kbd-hint">
      <kbd>Enter</kbd> Cut to Air &nbsp;·&nbsp; <kbd>Esc</kbd> Clear &nbsp;·&nbsp; <kbd>B</kbd> Bible &nbsp;·&nbsp; <kbd>S</kbd> Speaker &nbsp;·&nbsp; <kbd>T</kbd> Ticker
    </div>
    <div class="app-attribution">
      Copyright © 2026
      <a href="https://simplifyed.in" target="_blank" rel="noopener noreferrer">Jabez Vettriselvan</a>
      <span class="app-attribution-verse">“Freely you have received; freely give.” — Matthew 10:8</span>
    </div>
    </div>

    <!-- ── Settings ───────────────────────────────────────────────────────── -->
    <details class="settings-panel" id="settings-panel">
      <summary>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M4.93 4.93a10 10 0 0 0 0 14.14"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2"/></svg>
        <span class="settings-summary-label">Settings</span>
      </summary>
      <div class="settings-body">

        <!-- Chroma Key -->
        <div class="setting-row">
          <div class="setting-group span-full">
            <label class="setting-label">Chroma Key Background</label>
            <div class="chroma-options">
              <label class="chroma-opt">
                <input type="radio" name="chroma" value="#0000FF" checked onchange="onSettingsChange()" />
                <span class="chroma-swatch" style="background:#0000FF;"></span>
                Blue
              </label>
              <label class="chroma-opt">
                <input type="radio" name="chroma" value="#00B140" onchange="onSettingsChange()" />
                <span class="chroma-swatch" style="background:#00B140;"></span>
                Green
              </label>
              <label class="chroma-opt">
                <input type="radio" name="chroma" value="#FF00FF" onchange="onSettingsChange()" />
                <span class="chroma-swatch" style="background:#FF00FF;"></span>
                Magenta
              </label>
              <label class="chroma-opt custom-chroma-opt">
                <input type="radio" name="chroma" value="custom" onchange="onSettingsChange()" />
                <input type="color" id="custom-chroma-color" value="#0047AB"
                       oninput="onCustomChromaChange()" onchange="onCustomChromaChange()" />
                Custom
              </label>
              <label class="chroma-opt">
                <input type="radio" name="chroma" value="transparent" onchange="onSettingsChange()" />
                <span class="chroma-swatch chroma-swatch-alpha"></span>
                Transparent
              </label>
            </div>
            <!-- Transparent mode note -->
            <div class="chroma-transparent-note" id="chroma-transparent-note" style="display:none">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
              <span><strong>Transparent mode</strong> — for OBS/vMix/Wirecast Browser Source. In OBS: right-click the source → Properties → check <em>Allow transparency</em>. No chroma key filter needed.</span>
            </div>
          </div>
        </div>

        <div class="setting-row">
          <div class="setting-group span-full">
            <details class="settings-subsection">
              <summary>
                <span>Output Setup</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </summary>
              <div class="settings-subsection-body">
        <!-- Browser Source Connection -->
        <div class="setting-row">
          <div class="setting-group span-full">
            <div class="browser-source-info">
              <div class="bsi-tabs" role="tablist" aria-label="Output setup sections">
                <button type="button" id="output-tab-browser" class="bsi-tab is-active" onclick="setOutputSetupTab('browser')" role="tab" aria-selected="true">Browser Source</button>
                <button type="button" id="output-tab-atem" class="bsi-tab" onclick="setOutputSetupTab('atem')" role="tab" aria-selected="false">ATEM PNG Export</button>
              </div>

              <section id="output-panel-browser" class="bsi-panel is-active" role="tabpanel" aria-labelledby="output-tab-browser">
                <div class="bsi-row">
                  <span class="bsi-label">Output URL</span>
                  <code class="bsi-url" id="bsi-url">—</code>
                  <button class="bsi-copy" onclick="copyOutputLink()" title="Copy URL">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                  <details class="bsi-help">
                    <summary class="bsi-help-btn" title="Setup guidance">i</summary>
                    <div class="bsi-notes">
                      <p><strong>1. Add Browser Source:</strong> In OBS/vMix, add a Browser Source and paste the Output URL above.</p>
                      <p><strong>2. Match output size:</strong> Set width and height to your selected output resolution (for example 1920 × 1080).</p>
                      <p><strong>3. Choose keying mode:</strong> Use <em>Allow transparency</em> with Transparent mode, or use Chroma Key when a color background is selected.</p>
                    </div>
                  </details>
                </div>
              </section>

              <section id="output-panel-atem" class="bsi-panel" role="tabpanel" aria-labelledby="output-tab-atem" hidden>
                <div class="bsi-export-row">
                  <label class="bsi-pin-toggle" title="Enable ATEM PNG export updates for this session.">
                    <input type="checkbox" id="atem-pin-session" onchange="onAtemExportPinToggle()" />
                    <span>Include this session in ATEM export</span>
                  </label>
                  <span class="bsi-pin-state" id="atem-pin-state">Not included</span>
                </div>
                <div class="bsi-row bsi-atem-url-row">
                  <span class="bsi-label">ATEM PNG URL (Premultiplied)</span>
                  <code class="bsi-url" id="atem-export-url">/atem-live/&lt;session&gt;.png?alpha=premultiplied</code>
                  <button class="bsi-copy" onclick="copyAtemPremultipliedLink()" title="Copy ATEM Premultiplied PNG URL">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                  <button class="bsi-copy bsi-copy-text" id="atem-refresh-btn" onclick="onAtemExportRegenerate()" title="Regenerate ATEM PNG now">
                    Regenerate
                  </button>
                </div>
                <div class="bsi-row bsi-atem-url-row">
                  <span class="bsi-label">Preview PNG URL (Straight)</span>
                  <code class="bsi-url" id="atem-export-url-straight">/atem-live/&lt;session&gt;.png?alpha=straight</code>
                  <button class="bsi-copy" onclick="copyAtemStraightLink()" title="Copy Straight Alpha PNG URL for browser preview">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                </div>
              </section>
            </div>
          </div>
        </div>

        <!-- Animation + Style -->
        <div class="setting-row">
          <div class="setting-group">
            <label class="setting-label" for="anim-select">Animation</label>
            <select id="anim-select" onchange="onSettingsChange()">
              <option value="fade">Fade</option>
              <option value="slide">Slide Up</option>
              <option value="none">None (Instant)</option>
            </select>
          </div>

          <div class="setting-group">
            <label class="setting-label" for="style-select">Lower Third Style</label>
            <select id="style-select" onchange="onSettingsChange()">
              <option value="classic">Classic — Dark bar</option>
              <option value="accent">Accent line</option>
              <option value="minimal">Minimal — text only</option>
              <option value="outline">Outlined text</option>
              <option value="gradient" selected>Gradient fade</option>
              <option value="scripture">Scripture Wrap — full passage</option>
              <option value="scripture-panel">Scripture Panel — high-capacity</option>
              <option value="solid">Solid — Accent fill</option>
              <option value="split">Split lines</option>
              <option value="frosted">Frosted glass</option>
              <option value="inline-duo">Inline Duo — one-line modern</option>
              <option value="inline-chip">Inline Chip — highlighted line 2</option>
              <option value="inline-glass">Inline Glass — soft gradient</option>
            </select>
          </div>
        </div>

        <!-- Accent Color + Position -->
        <div class="setting-row">
          <div class="setting-group">
            <label class="setting-label" for="accent-color">Accent Color</label>
            <input type="color" id="accent-color" value="#C8A951" onchange="onSettingsChange()" />
          </div>

          <div class="setting-group">
            <label class="setting-label" for="position-select">Position</label>
            <select id="position-select" onchange="onSettingsChange()">
              <option value="lower">Lower Third</option>
              <option value="upper">Upper Third</option>
              <option value="center">Centered</option>
            </select>
          </div>
        </div>

        <div class="setting-row">
          <div class="setting-group">
            <label class="setting-label" for="lt-bg-color">Lower Third Background</label>
            <input type="color" id="lt-bg-color" value="#000000" onchange="onSettingsChange()" />
          </div>
          <div class="setting-group">
            <label class="setting-label" for="lt-bg-opacity">
              Background Opacity
              <span class="label-hint" id="lt-bg-opacity-val">0.88</span>
            </label>
            <div class="slider-row">
              <input type="range" id="lt-bg-opacity" min="0" max="1" step="0.01" value="0.88"
                     oninput="onLtBgOpacityInput()" onchange="onSettingsChange()" />
              <span class="slider-value" id="lt-bg-opacity-display">0.88</span>
            </div>
          </div>
        </div>

        <div class="setting-row">
          <div class="setting-group">
            <label class="setting-label" for="lt-width">
              Lower Third Width
              <span class="label-hint" id="lt-width-val">100%</span>
            </label>
            <div class="slider-row">
              <input type="range" id="lt-width" min="40" max="100" step="1" value="100"
                     oninput="onLtWidthInput()" onchange="onSettingsChange()" />
              <span class="slider-value" id="lt-width-display">100%</span>
            </div>
          </div>
          <div class="setting-group">
            <label class="template-toggle-label">
              <input type="checkbox" id="line2-multiline" onchange="onSettingsChange()" />
              Line 2 Multiline
            </label>
            <label class="setting-label" for="line2-max-lines">
              Max Line 2 Lines
              <span class="label-hint" id="line2-max-lines-val">2</span>
            </label>
            <div class="slider-row">
              <input type="range" id="line2-max-lines" min="1" max="6" step="1" value="2"
                     oninput="onLine2MaxLinesInput()" onchange="onSettingsChange()" />
              <span class="slider-value" id="line2-max-lines-display">2</span>
            </div>
          </div>
        </div>

        <!-- Text Alignment -->
        <div class="setting-row">
          <div class="setting-group span-full">
            <label class="setting-label">Text Alignment</label>
            <div class="align-options">
              <label class="align-opt">
                <input type="radio" name="textAlign" value="left" checked onchange="onSettingsChange()" />
                <svg viewBox="0 0 20 14" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="1" y1="2" x2="19" y2="2"/><line x1="1" y1="7" x2="13" y2="7"/><line x1="1" y1="12" x2="16" y2="12"/></svg>
                Left
              </label>
              <label class="align-opt">
                <input type="radio" name="textAlign" value="center" onchange="onSettingsChange()" />
                <svg viewBox="0 0 20 14" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="1" y1="2" x2="19" y2="2"/><line x1="4" y1="7" x2="16" y2="7"/><line x1="2" y1="12" x2="18" y2="12"/></svg>
                Center
              </label>
              <label class="align-opt">
                <input type="radio" name="textAlign" value="right" onchange="onSettingsChange()" />
                <svg viewBox="0 0 20 14" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="1" y1="2" x2="19" y2="2"/><line x1="7" y1="7" x2="19" y2="7"/><line x1="4" y1="12" x2="19" y2="12"/></svg>
                Right
              </label>
            </div>
          </div>
        </div>

        <!-- Output Resolution -->
        <div class="setting-row">
          <div class="setting-group">
            <label class="setting-label" for="output-res">Output Resolution</label>
            <select id="output-res" onchange="onSettingsChange()">
              <option value="1920x1080">1920 × 1080 (Full HD)</option>
              <option value="1280x720">1280 × 720 (HD)</option>
              <option value="3840x2160">3840 × 2160 (4K UHD)</option>
            </select>
          </div>
        </div>

              </div>
            </details>
          </div>
        </div>
        <div class="setting-row">
          <div class="setting-group span-full">
            <details class="settings-subsection">
              <summary>
                <span>Text Effects (Per Line)</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </summary>
              <div class="settings-subsection-body">
        <!-- Text Effects -->
        <div class="setting-row">
          <div class="setting-group span-full">
            <div class="textfx-tabs" role="tablist" aria-label="Text effects line selector">
              <button type="button" id="textfx-tab-line1" class="textfx-tab active" onclick="switchTextEffectsLine('line1')">Line 1</button>
              <button type="button" id="textfx-tab-line2" class="textfx-tab" onclick="switchTextEffectsLine('line2')">Line 2</button>
            </div>

            <div class="text-effects-grid">
              <div class="text-effects-card" id="textfx-card-line1">
                <div class="text-effects-title">Line 1</div>

                <div class="setting-group">
                  <label class="setting-label" for="line1-font-select">Font</label>
                  <select id="line1-font-select" onchange="onLineFontChange('line1')"></select>
                </div>

                <div class="textfx-2col">
                  <div class="setting-group">
                    <label class="setting-label" for="line1-font-weight">Weight</label>
                    <select id="line1-font-weight" onchange="onSettingsChange()"></select>
                  </div>
                  <div class="setting-group">
                    <label class="setting-label">Custom Color</label>
                    <div class="textfx-inline-check textfx-color-inline">
                      <input type="checkbox" id="line1-custom-color" onchange="onSettingsChange()" />
                      <label for="line1-custom-color">Custom Color</label>
                      <input type="color" id="line1-font-color" class="textfx-inline-color" value="#ffffff" onchange="onSettingsChange()" />
                    </div>
                  </div>
                </div>

                <div class="textfx-2col textfx-2col-compact">
                  <div class="setting-group">
                    <label class="setting-label" for="line1-font-scale">Font Size</label>
                    <div class="slider-row">
                      <input type="range" id="line1-font-scale" min="0.6" max="1.8" step="0.05" value="1"
                             oninput="onTextFxRangeInput('line1-font-scale','line1-font-scale-val','×')" />
                      <span class="slider-value" id="line1-font-scale-val">1×</span>
                    </div>
                  </div>
                  <div class="setting-group">
                    <label class="setting-label">Style</label>
                    <div class="textfx-inline-check">
                      <input type="checkbox" id="line1-italic" onchange="onSettingsChange()" />
                      <label for="line1-italic">Italic</label>
                    </div>
                  </div>
                </div>

                <div class="textfx-section collapsed">
                  <div class="textfx-section-head">
                    <label class="textfx-toggle-pill">
                      <input type="checkbox" id="line1-stroke-enabled" onchange="onTextFxSectionToggle('line1','stroke')" />
                      <span>Stroke</span>
                    </label>
                    <button type="button" class="textfx-collapse-btn" id="line1-stroke-collapse" onclick="toggleTextFxSection('line1','stroke')">▾</button>
                  </div>
                  <div class="textfx-section-body" id="line1-stroke-section">
                    <div class="setting-group">
                      <label class="setting-label" for="line1-stroke-color">Stroke Color</label>
                      <input type="color" id="line1-stroke-color" value="#000000" onchange="onSettingsChange()" />
                    </div>
                    <div class="setting-group">
                      <label class="setting-label" for="line1-stroke-width">Stroke Width</label>
                      <div class="slider-row">
                        <input type="range" id="line1-stroke-width" min="0" max="4" step="0.1" value="0"
                               oninput="onTextFxRangeInput('line1-stroke-width','line1-stroke-width-val','px')" />
                        <span class="slider-value" id="line1-stroke-width-val">0px</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="textfx-section collapsed">
                  <div class="textfx-section-head">
                    <label class="textfx-toggle-pill">
                      <input type="checkbox" id="line1-shadow-enabled" onchange="onTextFxSectionToggle('line1','shadow')" />
                      <span>Drop Shadow</span>
                    </label>
                    <button type="button" class="textfx-collapse-btn" id="line1-shadow-collapse" onclick="toggleTextFxSection('line1','shadow')">▾</button>
                  </div>
                  <div class="textfx-section-body" id="line1-shadow-section">
                    <div class="setting-group">
                      <label class="setting-label" for="line1-shadow-color">Shadow Color</label>
                      <input type="color" id="line1-shadow-color" value="#000000" onchange="onSettingsChange()" />
                    </div>
                    <div class="setting-group">
                      <label class="setting-label" for="line1-shadow-angle">Direction</label>
                      <div class="slider-row">
                        <input type="range" id="line1-shadow-angle" min="0" max="360" step="1" value="120"
                               oninput="onTextFxRangeInput('line1-shadow-angle','line1-shadow-angle-val','°')" />
                        <span class="slider-value" id="line1-shadow-angle-val">120°</span>
                      </div>
                    </div>
                    <div class="setting-group">
                      <label class="setting-label" for="line1-shadow-depth">Depth</label>
                      <div class="slider-row">
                        <input type="range" id="line1-shadow-depth" min="0" max="40" step="0.5" value="6"
                               oninput="onTextFxRangeInput('line1-shadow-depth','line1-shadow-depth-val','px')" />
                        <span class="slider-value" id="line1-shadow-depth-val">6px</span>
                      </div>
                    </div>
                    <div class="setting-group">
                      <label class="setting-label" for="line1-shadow-blur">Blur</label>
                      <div class="slider-row">
                        <input type="range" id="line1-shadow-blur" min="0" max="40" step="0.5" value="8"
                               oninput="onTextFxRangeInput('line1-shadow-blur','line1-shadow-blur-val','px')" />
                        <span class="slider-value" id="line1-shadow-blur-val">8px</span>
                      </div>
                    </div>
                    <div class="setting-group">
                      <label class="setting-label" for="line1-shadow-opacity">Opacity</label>
                      <div class="slider-row">
                        <input type="range" id="line1-shadow-opacity" min="0" max="1" step="0.05" value="0.85"
                               oninput="onTextFxRangeInput('line1-shadow-opacity','line1-shadow-opacity-val')" />
                        <span class="slider-value" id="line1-shadow-opacity-val">0.85</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="text-effects-card" id="textfx-card-line2" style="display:none">
                <div class="text-effects-title">Line 2</div>

                <div class="setting-group">
                  <label class="setting-label" for="line2-font-select">Font</label>
                  <select id="line2-font-select" onchange="onLineFontChange('line2')"></select>
                </div>

                <div class="textfx-2col">
                  <div class="setting-group">
                    <label class="setting-label" for="line2-font-weight">Weight</label>
                    <select id="line2-font-weight" onchange="onSettingsChange()"></select>
                  </div>
                  <div class="setting-group">
                    <label class="setting-label">Custom Color</label>
                    <div class="textfx-inline-check textfx-color-inline">
                      <input type="checkbox" id="line2-custom-color" onchange="onSettingsChange()" />
                      <label for="line2-custom-color">Custom Color</label>
                      <input type="color" id="line2-font-color" class="textfx-inline-color" value="#ffffff" onchange="onSettingsChange()" />
                    </div>
                  </div>
                </div>

                <div class="textfx-2col textfx-2col-compact">
                  <div class="setting-group">
                    <label class="setting-label" for="line2-font-scale">Font Size</label>
                    <div class="slider-row">
                      <input type="range" id="line2-font-scale" min="0.6" max="1.8" step="0.05" value="1"
                             oninput="onTextFxRangeInput('line2-font-scale','line2-font-scale-val','×')" />
                      <span class="slider-value" id="line2-font-scale-val">1×</span>
                    </div>
                  </div>
                  <div class="setting-group">
                    <label class="setting-label">Style</label>
                    <div class="textfx-inline-check">
                      <input type="checkbox" id="line2-italic" onchange="onSettingsChange()" />
                      <label for="line2-italic">Italic</label>
                    </div>
                  </div>
                </div>

                <div class="textfx-section collapsed">
                  <div class="textfx-section-head">
                    <label class="textfx-toggle-pill">
                      <input type="checkbox" id="line2-stroke-enabled" onchange="onTextFxSectionToggle('line2','stroke')" />
                      <span>Stroke</span>
                    </label>
                    <button type="button" class="textfx-collapse-btn" id="line2-stroke-collapse" onclick="toggleTextFxSection('line2','stroke')">▾</button>
                  </div>
                  <div class="textfx-section-body" id="line2-stroke-section">
                    <div class="setting-group">
                      <label class="setting-label" for="line2-stroke-color">Stroke Color</label>
                      <input type="color" id="line2-stroke-color" value="#000000" onchange="onSettingsChange()" />
                    </div>
                    <div class="setting-group">
                      <label class="setting-label" for="line2-stroke-width">Stroke Width</label>
                      <div class="slider-row">
                        <input type="range" id="line2-stroke-width" min="0" max="4" step="0.1" value="0"
                               oninput="onTextFxRangeInput('line2-stroke-width','line2-stroke-width-val','px')" />
                        <span class="slider-value" id="line2-stroke-width-val">0px</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="textfx-section collapsed">
                  <div class="textfx-section-head">
                    <label class="textfx-toggle-pill">
                      <input type="checkbox" id="line2-shadow-enabled" onchange="onTextFxSectionToggle('line2','shadow')" />
                      <span>Drop Shadow</span>
                    </label>
                    <button type="button" class="textfx-collapse-btn" id="line2-shadow-collapse" onclick="toggleTextFxSection('line2','shadow')">▾</button>
                  </div>
                  <div class="textfx-section-body" id="line2-shadow-section">
                    <div class="setting-group">
                      <label class="setting-label" for="line2-shadow-color">Shadow Color</label>
                      <input type="color" id="line2-shadow-color" value="#000000" onchange="onSettingsChange()" />
                    </div>
                    <div class="setting-group">
                      <label class="setting-label" for="line2-shadow-angle">Direction</label>
                      <div class="slider-row">
                        <input type="range" id="line2-shadow-angle" min="0" max="360" step="1" value="120"
                               oninput="onTextFxRangeInput('line2-shadow-angle','line2-shadow-angle-val','°')" />
                        <span class="slider-value" id="line2-shadow-angle-val">120°</span>
                      </div>
                    </div>
                    <div class="setting-group">
                      <label class="setting-label" for="line2-shadow-depth">Depth</label>
                      <div class="slider-row">
                        <input type="range" id="line2-shadow-depth" min="0" max="40" step="0.5" value="4"
                               oninput="onTextFxRangeInput('line2-shadow-depth','line2-shadow-depth-val','px')" />
                        <span class="slider-value" id="line2-shadow-depth-val">4px</span>
                      </div>
                    </div>
                    <div class="setting-group">
                      <label class="setting-label" for="line2-shadow-blur">Blur</label>
                      <div class="slider-row">
                        <input type="range" id="line2-shadow-blur" min="0" max="40" step="0.5" value="6"
                               oninput="onTextFxRangeInput('line2-shadow-blur','line2-shadow-blur-val','px')" />
                        <span class="slider-value" id="line2-shadow-blur-val">6px</span>
                      </div>
                    </div>
                    <div class="setting-group">
                      <label class="setting-label" for="line2-shadow-opacity">Opacity</label>
                      <div class="slider-row">
                        <input type="range" id="line2-shadow-opacity" min="0" max="1" step="0.05" value="0.75"
                               oninput="onTextFxRangeInput('line2-shadow-opacity','line2-shadow-opacity-val')" />
                        <span class="slider-value" id="line2-shadow-opacity-val">0.75</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

              </div>
            </details>
          </div>
        </div>
        <!-- Custom Image & Logo -->
        <div class="setting-row">
          <div class="setting-group span-full">
            <details class="settings-subsection">
              <summary>
                <span>Custom Image &amp; Logo</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </summary>
              <div class="settings-subsection-body">
                <div class="setting-row">
                  <div class="setting-group span-full">
                    <label class="setting-label">Lower Third Background Image</label>
                    <div class="file-row">
                      <label class="file-btn" for="lt-bg-file">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                        Choose Image
                        <input type="file" id="lt-bg-file" accept="image/*" onchange="onLtBgChange()" />
                      </label>
                      <button class="file-clear-btn" id="lt-bg-clear" onclick="clearLtBg()" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        Clear
                      </button>
                      <span class="file-name" id="lt-bg-name">No image selected</span>
                    </div>
                    <div class="file-preview-wrap" id="lt-bg-preview-wrap" style="display:none">
                      <img id="lt-bg-preview" class="file-preview-img" alt="Lower third background preview" />
                    </div>
                    <div class="bg-fit-controls" id="bg-fit-controls" style="display:none">
                      <div class="setting-group">
                        <label class="setting-label" for="lt-bg-size">Image Fit</label>
                        <select id="lt-bg-size" onchange="onSettingsChange()">
                          <option value="cover">Cover (fill, may crop)</option>
                          <option value="contain">Contain (full image, no crop)</option>
                          <option value="stretch">Stretch (exact fill)</option>
                        </select>
                      </div>
                      <div class="setting-group">
                        <label class="setting-label" for="lt-bg-position">Vertical Focus</label>
                        <select id="lt-bg-position" onchange="onSettingsChange()">
                          <option value="center center">Center</option>
                          <option value="top center">Top</option>
                          <option value="bottom center">Bottom</option>
                        </select>
                      </div>
                      <div class="setting-group span-full">
                        <label class="setting-label" for="lt-min-height">
                          Min Bar Height
                          <span class="label-hint">keeps bar consistent when only 1 line shows</span>
                        </label>
                        <div class="slider-row">
                          <input type="range" id="lt-min-height" min="0" max="240" step="10" value="0"
                                 oninput="onLtMinHeightInput()" onchange="onSettingsChange()" />
                          <span class="slider-value" id="lt-min-height-val">auto</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="setting-row">
                  <div class="setting-group span-full">
                    <label class="setting-label">Logo (PNG with transparency)</label>
                    <div class="file-row">
                      <label class="file-btn" for="logo-file">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                        Choose Logo
                        <input type="file" id="logo-file" accept="image/png,image/svg+xml,image/*" onchange="onLogoChange()" />
                      </label>
                      <button class="file-clear-btn" id="logo-clear" onclick="clearLogo()" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        Clear
                      </button>
                      <span class="file-name" id="logo-name">No logo selected</span>
                    </div>
                    <div class="logo-controls" id="logo-controls" style="display:none">
                      <div class="logo-preview-wrap">
                        <img id="logo-preview" class="logo-preview-img" alt="Logo preview" />
                      </div>
                      <div class="setting-group">
                        <label class="setting-label" for="logo-position">Logo Position</label>
                        <select id="logo-position" onchange="onSettingsChange()">
                          <option value="left">Left side</option>
                          <option value="right">Right side</option>
                        </select>
                      </div>
                      <div class="setting-group span-full">
                        <label class="setting-label" for="logo-size">
                          Logo Size
                          <span class="label-hint">max height in output</span>
                        </label>
                        <div class="slider-row">
                          <input type="range" id="logo-size" min="40" max="240" step="10" value="110"
                                 oninput="onLogoSizeInput()" onchange="onSettingsChange()" />
                          <span class="slider-value" id="logo-size-val">110px</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </details>
          </div>
        </div>

        <!-- Custom Lower-Third Template Editor -->
        <div class="setting-row">
          <div class="setting-group span-full">
            <details class="settings-subsection">
              <summary>
                <span class="template-section-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                  Custom HTML Template
                </span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </summary>
              <div class="settings-subsection-body">
                <div class="template-enable-row">
                  <label class="template-toggle-label">
                    <input type="checkbox" id="use-custom-template" onchange="onSettingsChange()" />
                    Enable custom template (overrides all style settings)
                  </label>
                  <div class="template-example-row">
                    <select id="template-example-select">
                      <option value="classic">Classic Dark</option>
                      <option value="bg-image">Background Image</option>
                      <option value="logo-bar">Logo + Dark Bar</option>
                      <option value="light">Minimal Light</option>
                      <option value="scroll">Scripture Scroll</option>
                    </select>
                    <button class="btn-reset-template"
                            onclick="loadTemplate(document.getElementById('template-example-select').value)">
                      Load Example
                    </button>
                  </div>
                </div>
                <div class="template-fields">
                  <div class="template-field-group">
                    <label class="setting-label">HTML
                      <span class="label-hint">Variables: &#123;&#123;line1&#125;&#125; &#123;&#123;line2&#125;&#125; &#123;&#123;accentColor&#125;&#125; &#123;&#123;font&#125;&#125; &#123;&#123;line1Font&#125;&#125; &#123;&#123;line2Font&#125;&#125; &#123;&#123;logoUrl&#125;&#125; &#123;&#123;bgUrl&#125;&#125;</span>
                    </label>
                    <textarea id="template-html" class="template-textarea" rows="6"
                      onchange="onSettingsChange()" oninput="onSettingsChange()"
                      placeholder="<div class=&quot;my-lt&quot;>&#10;  <div class=&quot;line1&quot;>{{line1}}</div>&#10;</div>"></textarea>
                  </div>
                  <div class="template-field-group">
                    <label class="setting-label">CSS</label>
                    <textarea id="template-css" class="template-textarea" rows="8"
                      onchange="onSettingsChange()" oninput="onSettingsChange()"
                      placeholder=".my-lt { background: rgba(0,0,0,.85); padding: 20px; }"></textarea>
                  </div>
                </div>
                <div class="template-preset-row">
                  <select id="template-preset-select" class="template-preset-select">
                    <option value="">No template presets yet</option>
                  </select>
                  <button class="btn-reset-template" onclick="saveTemplatePreset()" title="Save current custom HTML/CSS as a reusable template preset">
                    Save Template Preset
                  </button>
                  <button class="btn-reset-template" onclick="loadSelectedTemplatePreset()" title="Load selected template preset">
                    Load Preset
                  </button>
                  <button class="btn-reset-template" onclick="deleteSelectedTemplatePreset()" title="Delete selected template preset">
                    Delete
                  </button>
                </div>
              </div>
            </details>
          </div>
        </div>

        <!-- Output Window Watermark -->
        <div class="setting-row">
          <div class="setting-group span-full">
            <label class="setting-label">Output Window</label>
            <label class="template-toggle-label">
              <input type="checkbox" id="show-session-watermark" onchange="onSettingsChange()" />
              Show session ID watermark
              <span class="inline-help-dot" title="Show session ID watermark on output window (for confirming correct session pairing)">i</span>
            </label>
          </div>
        </div>
      </div>
    </details>

  </main>
</div>

<!-- ── In-App User Guide ─────────────────────────────────────────────── -->
<div id="user-guide-modal" class="guide-modal" aria-hidden="true" role="dialog" aria-labelledby="guide-title">
  <div class="guide-backdrop" onclick="closeUserGuide()"></div>
  <div class="guide-dialog" role="document">
    <div class="guide-header">
      <h2 id="guide-title">Overlay User Guide</h2>
      <button class="guide-close" onclick="closeUserGuide()" aria-label="Close guide">×</button>
    </div>
    <div class="guide-body">
      <section class="guide-section">
        <h3>1. Session Setup and Pairing</h3>
        <ol>
          <li>Open Control UI at <code>/</code>.</li>
          <li>Open Output at <code>/output.html?session=&lt;id&gt;</code>.</li>
          <li>Keep the same session ID in all windows/devices for that production lane.</li>
          <li>Use one session per independent output pipeline.</li>
        </ol>
      </section>

      <section class="guide-section">
        <h3>2. Live Operation Runbook</h3>
        <ol>
          <li>Select mode: <code>Bible</code>, <code>Speaker</code>, or <code>Ticker</code>.</li>
          <li>Build content and verify in <code>PVW</code>.</li>
          <li>Press <code>CUT TO AIR</code> to push to <code>PGM</code> and Output.</li>
          <li>Press <code>CLEAR</code> to remove active lower-third/ticker output.</li>
        </ol>
        <p>Always treat PVW as final QA before every cut.</p>
      </section>

      <section class="guide-section">
        <h3>3. Bible Mode (Recommended Flow)</h3>
        <ol>
          <li>Choose Book / Chapter / Verse(s).</li>
          <li>Select translation and reference language.</li>
          <li>Set line behavior:
            <ul>
              <li><code>Hide translation line (Line 2)</code></li>
              <li><code>Append translation abbreviation on line 1</code></li>
            </ul>
          </li>
          <li>Optional: click <code>Look Up Text</code>.</li>
          <li>Enable <code>Use verse text as line 2 in output</code> only when you want passage text on-air.</li>
          <li>Check PVW and cut to air.</li>
        </ol>
      </section>

      <section class="guide-section">
        <h3>4. Speaker and Ticker</h3>
        <ul>
          <li>Speaker: speaker name is primary; role/title is optional.</li>
          <li>Ticker: configure message, badge, style, speed, position, and colors.</li>
          <li>Ticker can be run independently from lower-thirds.</li>
        </ul>
      </section>

      <section class="guide-section">
        <h3>5. Styles, Text Effects, and Templates</h3>
        <ul>
          <li><code>Lower Third Style</code> controls layout family and base visual style.</li>
          <li><code>Text Effects (Per Line)</code> controls line-specific font, weight, size, color, stroke, and drop shadow.</li>
          <li>Use Line 2 multiline for long scripture passages.</li>
          <li><code>Custom HTML Template</code> overrides built-in styles completely.</li>
          <li>Template variables: <code>{{line1}}</code>, <code>{{line2}}</code>, <code>{{accentColor}}</code>, <code>{{line1Font}}</code>, <code>{{line2Font}}</code>, <code>{{logoUrl}}</code>, <code>{{bgUrl}}</code>.</li>
        </ul>
      </section>

      <section class="guide-section">
        <h3>6. Presets and Settings Profiles</h3>
        <ul>
          <li>Presets speed up content recall (Reference/Speaker/Ticker/Template).</li>
          <li>Settings Profiles store full operational state and presets together.</li>
          <li>Use Export/Import for transfer between machines/servers.</li>
        </ul>
      </section>

      <section class="guide-section">
        <h3>7. Output Setup: Browser Source</h3>
        <ol>
          <li>Open <code>Settings → Output Setup → Browser Source</code>.</li>
          <li>Copy Output URL and add it as a browser source in OBS/vMix/Wirecast.</li>
          <li>Match source resolution to selected output resolution.</li>
          <li>For alpha pipelines use <code>Transparent</code> mode and enable transparency in the switcher software.</li>
          <li>For chroma workflows use Blue/Green/Magenta/Custom and key that color downstream.</li>
        </ol>
      </section>

      <section class="guide-section">
        <h3>8. Output Setup: ATEM PNG Export</h3>
        <ol>
          <li>Open <code>Settings → Output Setup → ATEM PNG Export</code>.</li>
          <li>Include/pin the current session for ATEM export.</li>
          <li>Use session PNG endpoints:
            <ul>
              <li><code>/atem-live/&lt;session&gt;.png?alpha=premultiplied</code> for ATEM production use.</li>
              <li><code>/atem-live/&lt;session&gt;.png?alpha=straight</code> for browser QA/comparison.</li>
            </ul>
          </li>
          <li>Use <code>Regenerate</code> if immediate refresh is required.</li>
          <li>If preview mismatch appears, compare straight and premultiplied outputs first.</li>
        </ol>
      </section>

      <section class="guide-section">
        <h3>9. Multi-Session Best Practices</h3>
        <ul>
          <li>Keep each operator/program lane on its own session ID.</li>
          <li>Pin only sessions that must publish ATEM PNG outputs.</li>
          <li>Avoid sharing one session across unrelated productions.</li>
        </ul>
      </section>

      <section class="guide-section">
        <h3>10. Keyboard and Fast Operations</h3>
        <p><code>Enter</code> Cut, <code>Esc</code> Clear, <code>B</code> Bible, <code>S</code> Speaker, <code>T</code> Ticker, <code>O</code> Output Window, <code>H</code> User Guide.</p>
      </section>

      <section class="guide-section">
        <h3>11. Troubleshooting</h3>
        <ul>
          <li>No live sync: verify matching session ID and active WebSocket connection.</li>
          <li>Output differs from PVW/PGM: check active mode, cut state, and template override.</li>
          <li>ATEM PNG differs from output: regenerate and compare straight vs premultiplied variants.</li>
          <li>Layout issues on small screens: keep settings collapsed while operating live.</li>
        </ul>
      </section>
    </div>
  </div>
</div>
<script src="js/data.js"></script>
<script src="js/control.js"></script>
</body>
</html>
